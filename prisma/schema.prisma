// ===========================================
// ASARA  - Schéma de base de données
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Enums
// ===========================================

enum UserRole {
  ADMIN
  PROFESSIONAL
  MEMBER
}

enum UserStatus {
  PENDING
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum EventType {
  DOCUMENT
  GALLERY
}

// ===========================================
// User Model
// ===========================================

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  passwordHash  String
  role          UserRole    @default(MEMBER)
  status        UserStatus  @default(PENDING)
  
  // Informations personnelles
  firstName     String
  lastName      String
  phone         String?
  address       String?
  city          String?
  postalCode    String?
  
  // Profil professionnel
  profile       ProfessionalProfile?
  
  // Stripe
  stripeCustomerId String?  @unique
  
  // Relations
  subscriptions Subscription[]
  payments      Payment[]
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastLoginAt   DateTime?
  
  // Email verification
  emailVerified Boolean     @default(false)
  emailVerifiedAt DateTime?
  
  // Password reset
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?
  
  // Newsletter preference (marketing uniquement)
  newsletterOptIn Boolean @default(true)

  @@index([email])
  @@index([status])
  @@index([role])
  @@index([resetToken])
  @@map("users")


  // forum
forumThreads   ForumThread[]  @relation("ThreadAuthor")
forumReplies   ForumReply[]   @relation("ReplyAuthor")
deletedThreads ForumThread[]  @relation("ThreadDeletedBy")
deletedReplies ForumReply[]   @relation("ReplyDeletedBy")
forumBan       ForumBan?      @relation("BannedUser")
forumBansGiven ForumBan[]     @relation("BannedBy")
}

// ===========================================
// Professional Profile
// ===========================================

model ProfessionalProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyName     String?
  profession      String
  category        String
  specialty       String?
  description     String?   @db.Text
  
  address         String?
  city            String?
  postalCode      String?
  country         String    @default("France")
  latitude        Float?
  longitude       Float?
  
  professionalPhone String?
  professionalEmail String?
  website         String?
  
  linkedinUrl     String?
  facebookUrl     String?
  instagramUrl    String?
  
  photoUrl        String?
  logoUrl         String?
  
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  
  slug            String    @unique
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([category])
  @@index([city])
  @@index([isPublished])
  @@index([slug])
  @@map("professional_profiles")
}

// ===========================================
// Categories
// ===========================================

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  icon        String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("categories")
}

// ===========================================
// Subscription
// ===========================================

model Subscription {
  id                  String              @id @default(cuid())
  userId              String
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type                UserRole
  
  stripeSubscriptionId String?            @unique
  stripePriceId       String?
  
  status              SubscriptionStatus  @default(ACTIVE)
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  
  cancelAtPeriodEnd   Boolean             @default(false)
  canceledAt          DateTime?
  
  payments            Payment[]
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

// ===========================================
// Payment
// ===========================================

model Payment {
  id                  String        @id @default(cuid())
  userId              String
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionId      String?
  subscription        Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  amount              Int
  currency            String        @default("eur")
  
  stripePaymentIntentId String?     @unique
  stripeInvoiceId     String?       @unique
  
  status              PaymentStatus @default(PENDING)
  
  invoiceNumber       String?       @unique
  invoiceUrl          String?
  
  description         String?
  
  createdAt           DateTime      @default(now())
  paidAt              DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ===========================================
// Email Templates
// ===========================================

model EmailTemplate {
  id          String    @id @default(cuid())
  name        String    @unique
  subject     String
  htmlContent String    @db.Text
  textContent String?   @db.Text
  variables   String?   @db.Text
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("email_templates")
}

// ===========================================
// Email Logs
// ===========================================

model EmailLog {
  id          String    @id @default(cuid())
  to          String
  subject     String
  templateId  String?
  status      String
  error       String?
  
  sentAt      DateTime  @default(now())
  
  @@index([to])
  @@index([sentAt])
  @@map("email_logs")
}

// ===========================================
// Settings
// ===========================================

model Setting {
  id          String    @id @default(cuid())
  key         String    @unique
  value       String    @db.Text
  description String?
  
  updatedAt   DateTime  @updatedAt
  
  @@map("settings")
}

// ===========================================
// Event
// ===========================================

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  type        EventType @default(GALLERY)
  
  documentUrl String?
  
  imageUrl1   String?
  imageUrl2   String?
  imageUrl3   String?
  
  eventDate   DateTime?
  location    String?
  
  isPublished Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("events")
}

model Article {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  authorName  String
  authorEmail String?
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Newsletter {
  id          String   @id @default(cuid())
  subject     String
  sentAt      DateTime?
  recipientCount Int   @default(0)
  createdAt   DateTime @default(now())
}

model Subscriber {
  id          String   @id @default(cuid())
  email       String   @unique
  firstName   String
  lastName    String
  locale      String   @default("fr")
  isActive    Boolean  @default(true)
  confirmedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model NewsletterLink {
  id        String   @id @default(cuid())
  title     String
  url       String
  source    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ForumCategory {
  id          String   @id @default(cuid())
  name        String
  nameAr      String?
  slug        String   @unique
  description String?
  color       String   @default("#16a34a")
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  threads     ForumThread[]
  @@map("forum_categories")
}

model ForumThread {
  id           String        @id @default(cuid())
  title        String
  content      String        @db.Text
  slug         String        @unique
  authorId     String
  categoryId   String
  isPinned     Boolean       @default(false)
  isLocked     Boolean       @default(false)
  isDeleted    Boolean       @default(false)
  deletedAt    DateTime?
  deletedById  String?
  viewCount    Int           @default(0)
  replyCount   Int           @default(0)
  lastReplyAt  DateTime      @default(now())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  author       User          @relation("ThreadAuthor", fields: [authorId], references: [id])
  category     ForumCategory @relation(fields: [categoryId], references: [id])
  replies      ForumReply[]
  deletedBy    User?         @relation("ThreadDeletedBy", fields: [deletedById], references: [id])
  @@index([categoryId])
  @@index([authorId])
  @@index([lastReplyAt])
  @@map("forum_threads")
}

model ForumReply {
  id          String      @id @default(cuid())
  content     String      @db.Text
  authorId    String
  threadId    String
  isDeleted   Boolean     @default(false)
  deletedAt   DateTime?
  deletedById String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  author      User        @relation("ReplyAuthor", fields: [authorId], references: [id])
  thread      ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  deletedBy   User?       @relation("ReplyDeletedBy", fields: [deletedById], references: [id])
  @@index([threadId])
  @@index([authorId])
  @@map("forum_replies")
}

model ForumBan {
  id          String    @id @default(cuid())
  userId      String    @unique
  reason      String
  bannedById  String
  bannedAt    DateTime  @default(now())
  expiresAt   DateTime?
  isPermanent Boolean   @default(false)
  user        User      @relation("BannedUser", fields: [userId], references: [id])
  bannedBy    User      @relation("BannedBy", fields: [bannedById], references: [id])
  @@map("forum_bans")
}
